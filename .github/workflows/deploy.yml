name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£… Zola (LTS ç‰ˆæœ¬)
        run: |
          set -e
          curl -sSL https://github.com/getzola/zola/releases/download/v0.19.1/zola-v0.19.1-x86_64-unknown-linux-gnu.tar.gz | tar xzf -
          sudo install zola /usr/local/bin
          zola --version

      - name: ğŸ§¹ æ¸…ç†æ—§æ„å»º
        run: |
          rm -rf public/
          echo "å·²æ¸…ç† public/ ç›®å½•"

      - name: ğŸ—ï¸ æ„å»ºç½‘ç«™
        run: |
          echo "[info] ä½¿ç”¨å·²å®‰è£…çš„ Zola æ„å»º..."
          zola build --base-url "https://www.liyupoetry.com"
          echo "[success] Zola æ„å»ºå®Œæˆ"
          echo "[info] ç”Ÿæˆçš„ HTML æ–‡ä»¶æ•°é‡: $(find public/ -name "*.html" | wc -l)"
          echo "[info] ç”Ÿæˆç›®å½•ç»“æ„:"
          ls -la public/ | head -10

      - name: ğŸ” éªŒè¯æ„å»ºç»“æœ
        run: |
          if [ ! -f "public/index.html" ]; then
            echo "âŒ é”™è¯¯: public/index.html ä¸å­˜åœ¨"
            exit 1
          fi

          PAGE_COUNT=$(find public/ -name "*.html" | wc -l)
          if [ "$PAGE_COUNT" -lt 50 ]; then
            echo "âŒ è­¦å‘Š: ç”Ÿæˆçš„é¡µé¢æ•°é‡å¤ªå°‘ (< 50): $PAGE_COUNT"
            exit 1
          fi

          echo "âœ… æ„å»ºéªŒè¯é€šè¿‡: $PAGE_COUNT ä¸ª HTML é¡µé¢"

      - name: ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages
        if: github.ref == 'refs/heads/main'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ secrets.CF_PROJECT_NAME }}
          directory: ./public
          branch: main
