name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 18 1 * *"
  repository_dispatch:
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ‚è¨ Install zola
        run: sudo snap install --edge zola

      - name: ‚è¨ Install gh-stats
        run: |
          set -e
          mkdir bin
          curl -sSL https://github.com/mre/gh-stats/releases/download/v0.1.0/gh-stats-v0.1.0-x86_64-unknown-linux-gnu.tar.gz | tar xz --directory=bin
          sudo install "$(pwd)/bin/gh-stats" /usr/local/bin

      - name: ‚è¨ Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: ‚è¨ Install tinysearch
        run: |
          set -e
          curl -sSL https://github.com/tinysearch/tinysearch/releases/download/v0.8.2/tinysearch-v0.8.2-x86_64-unknown-linux-gnu.tar.gz | tar xz
          sudo install "$(pwd)/tinysearch" /usr/local/bin

      - name: ‚è¨ Install cavif
        run: |
          set -e
          curl -sSL https://github.com/kornelski/cavif-rs/releases/download/v1.3.3/cavif-1.3.3.zip --output cavif.zip
          unzip cavif.zip -d cavif
          sudo install "$(pwd)/cavif/linux-generic/cavif" /usr/local/bin

      - name: ‚è¨ Install binaryen
        run: |
          set -e
          curl -L https://github.com/WebAssembly/binaryen/releases/download/version_104/binaryen-version_104-x86_64-linux.tar.gz | tar xzf -
          sudo install "$(pwd)/binaryen-version_104/bin/wasm-opt" /usr/local/bin

      - name: ‚è¨ Install terser
        run: sudo npm install -g terser

      - name: ‚è¨ Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: üîó Alias ImageMagick
        run: sudo ln -s /usr/bin/convert /usr/bin/magick

      - name: üîç Tool versions
        run: make versions

      - name: üìñ Build website
        run: |
          make clean
          make content
          echo "Build completed. Public directory contents:"
          ls -la public/

      - name: üì¶ Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages
          path: ./public

  deploy-to-github-pages:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-to-cloudflare:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üì• Checkout and build
        uses: actions/checkout@v4

      - name: ‚è¨ Install zola
        run: sudo snap install --edge zola

      - name: üìñ Build website
        run: |
          make clean
          make content
          echo "Build completed for Cloudflare deployment"

      - name: üîç Check Cloudflare configuration
        id: check-cloudflare
        run: |
          echo "Checking Cloudflare configuration..."
          echo "CF_API_TOKEN configured: ${{ secrets.CF_API_TOKEN != '' }}"
          echo "CF_ACCOUNT_ID configured: ${{ secrets.CF_ACCOUNT_ID != '' }}"

          if [ -z "${{ secrets.CF_API_TOKEN }}" ]; then
            echo "‚ùå CF_API_TOKEN secret is not configured"
            echo "Cloudflare Pages deployment will be skipped"
            echo "To enable Cloudflare Pages deployment:"
            echo "1. Go to GitHub repository Settings > Secrets and variables > Actions"
            echo "2. Add CF_API_TOKEN (Cloudflare API Token)"
            echo "3. Add CF_ACCOUNT_ID (Cloudflare Account ID)"
            echo "status=skipped" >> $GITHUB_OUTPUT
          elif [ -z "${{ secrets.CF_ACCOUNT_ID }}" ]; then
            echo "‚ùå CF_ACCOUNT_ID secret is not configured"
            echo "Cloudflare Pages deployment will be skipped"
            echo "status=skipped" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Cloudflare configuration detected"
            echo "status=ready" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Deploy to Cloudflare Pages
        if: steps.check-cloudflare.outputs.status == 'ready'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: liyupoetry
          directory: ./public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          wranglerVersion: "3"

  validate:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [deploy-to-github-pages, deploy-to-cloudflare]
    steps:
      - name: üìä Deployment Status
        run: |
          echo "=== Deployment Status ==="
          echo "GitHub Pages: ‚úÖ Always deployed"
          echo "Cloudflare Pages: ${{ needs.deploy-to-cloudflare.result }}"
          echo "Cloudflare Secrets Configured: ${{ secrets.CF_API_TOKEN != '' && secrets.CF_ACCOUNT_ID != '' }}"

      - name: ‚è≥ Wait for deployment propagation
        run: |
          echo "Waiting for deployments to propagate..."
          sleep 30

      - name: ‚úÖ Validate deployments
        run: |
          echo "Validating deployments..."

          # Function to check URL with retries
          check_url() {
            local url=$1
            local description=$2
            local max_retries=3
            local retry_count=0

            while [ $retry_count -lt $max_retries ]; do
              echo "üîç Checking $description (attempt $((retry_count + 1))/$max_retries)..."
              local status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$url")

              if [ "$status" = "200" ]; then
                echo "‚úÖ $description is accessible (HTTP 200)"
                return 0
              else
                echo "‚ö†Ô∏è $description returned HTTP $status (expected 200)"
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  sleep 10
                fi
              fi
            done

            echo "‚ùå $description failed after $max_retries attempts"
            return 1
          }

          # Track results
          success_count=0
          total_checks=0

          # URLs to check
          declare -A urls=(
            ["https://lukethecat.github.io/"]="GitHub Pages Homepage"
            ["https://lukethecat.github.io/1995hanxuema/"]="GitHub Pages Ê±óË°ÄÈ©¨ËØóÈõÜ"
            ["https://lukethecat.github.io/1980/"]="GitHub Pages 1980ËØóÈõÜ"
            ["https://lukethecat.github.io/archive/"]="GitHub Pages Archive"
          )

          # Add Cloudflare URLs if configured
          if [ -n "${{ secrets.CF_API_TOKEN }}" ] && [ -n "${{ secrets.CF_ACCOUNT_ID }}" ]; then
            urls["https://www.liyupoetry.com/"]="Cloudflare Pages Homepage"
            urls["https://www.liyupoetry.com/1995hanxuema/"]="Cloudflare Pages Ê±óË°ÄÈ©¨ËØóÈõÜ"
            urls["https://www.liyupoetry.com/1980/"]="Cloudflare Pages 1980ËØóÈõÜ"
            urls["https://www.liyupoetry.com/archive/"]="Cloudflare Pages Archive"
            urls["https://www.liyupoetry.com/test-deployment.txt"]="Cloudflare Pages Test File"
          else
            echo "‚ö†Ô∏è Cloudflare Pages not configured - skipping validation"
            echo "To enable Cloudflare Pages, configure CF_API_TOKEN and CF_ACCOUNT_ID secrets"
          fi

          # Check all URLs
          for url in "${!urls[@]}"; do
            total_checks=$((total_checks + 1))
            if check_url "$url" "${urls[$url]}"; then
              success_count=$((success_count + 1))
            fi
          done

          # Summary
          echo ""
          echo "========== Deployment Validation Summary =========="
          echo "‚úÖ Passed: $success_count / $total_checks"

          if [ "$success_count" -eq "$total_checks" ]; then
            echo "üéâ All deployments validated successfully!"
            exit 0
          elif [ "$success_count" -ge $((total_checks / 2)) ]; then
            echo "‚ö†Ô∏è Partial success. Some deployments may need attention."
            echo "üìã Next steps:"
            echo "   1. Check GitHub Actions logs for errors"
            echo "   2. Wait 5-10 minutes and re-check (CDN propagation time)"
            echo "   3. Verify GitHub Secrets configuration if Cloudflare failed"
            exit 0  # Partial success is acceptable
          else
            echo "‚ùå Multiple deployments failed. Please review."
            echo "üìã Troubleshooting:"
            echo "   1. Check build logs for errors"
            echo "   2. Verify GitHub Pages settings"
            echo "   3. Check Cloudflare Pages dashboard if configured"
            echo "   4. Review GitHub Secrets configuration"
            exit 1
          fi

  summary:
    if: always() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build, deploy-to-github-pages, deploy-to-cloudflare, validate]
    steps:
      - name: üìä Deployment Summary
        run: |
          echo "========== Deployment Summary =========="
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Trigger: ${{ github.event_name }}"
          echo ""
          echo "Deployment Targets:"
          echo "  ‚úÖ GitHub Pages: https://lukethecat.github.io"
          if [ -n "${{ secrets.CF_API_TOKEN }}" ] && [ -n "${{ secrets.CF_ACCOUNT_ID }}" ]; then
            echo "  ‚úÖ Cloudflare Pages: https://www.liyupoetry.com"
          else
            echo "  ‚ö†Ô∏è Cloudflare Pages: Not configured (missing secrets)"
          fi
          echo ""
          echo "Key Pages:"
          echo "  ‚Ä¢ Homepage: https://lukethecat.github.io/"
          echo "  ‚Ä¢ Ê±óË°ÄÈ©¨ËØóÈõÜ: https://lukethecat.github.io/1995hanxuema/"
          echo "  ‚Ä¢ 1980ËØóÈõÜ: https://lukethecat.github.io/1980/"
          echo "  ‚Ä¢ Archive: https://lukethecat.github.io/archive/"
          echo ""
          echo "Next Steps:"
          echo "  1. Visit the website to verify content"
          echo "  2. Check for any broken links or missing pages"
          echo "  3. Monitor GitHub Actions for future deployments"
          echo ""
          if [ -z "${{ secrets.CF_API_TOKEN }}" ] || [ -z "${{ secrets.CF_ACCOUNT_ID }}" ]; then
            echo "‚ö†Ô∏è To enable Cloudflare Pages deployment:"
            echo "   ‚Ä¢ Add CF_API_TOKEN and CF_ACCOUNT_ID secrets in GitHub"
            echo "   ‚Ä¢ See docs/DEPLOYMENT_SETUP.md for instructions"
            echo ""
            echo "üìù Current Cloudflare Pages Status:"
            echo "   The domain www.liyupoetry.com points to Cloudflare"
            echo "   but automatic deployment is not configured."
            echo "   The site shows old content from a previous manual deployment."
            echo ""
            echo "üîß Quick Fix Options:"
            echo "   1. Configure GitHub Secrets for automatic deployment (recommended)"
            echo "   2. Point www.liyupoetry.com to GitHub Pages instead"
            echo "   3. Manually deploy to Cloudflare Pages dashboard"
          fi
